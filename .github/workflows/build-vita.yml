name: Build PlayStation Vita Package

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-vita:
    name: "Build for PlayStation Vita"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: vitasdk/vitasdk:latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        apk add cmake ninja git pkgconfig make curl bash tar wget

    - name: Setup VitaSDK and vdpm
      run: |
        # Setup environment variables
        export VITASDK=/usr/local/vitasdk
        export PATH=$VITASDK/bin:$PATH
        
        echo "VITASDK=$VITASDK" >> $GITHUB_ENV
        echo "$VITASDK/bin" >> $GITHUB_PATH
        
        # Clone and setup vdpm
        echo "Setting up vdpm..."
        cd /tmp
        git clone --depth=1 https://github.com/vitasdk/vdpm.git
        cd vdpm
        
        # Bootstrap VitaSDK (this sets up the toolchain if not present)
        bash bootstrap-vitasdk.sh
        
        # Verify VitaSDK installation
        echo "Verifying VitaSDK installation..."
        which arm-vita-eabi-gcc
        arm-vita-eabi-gcc --version

    - name: Install SDL2 libraries via vdpm
      run: |
        export VITASDK=/usr/local/vitasdk
        export PATH=$VITASDK/bin:$PATH
        
        # Install SDL2 and related libraries using vdpm
        echo "Installing SDL2 libraries..."
        cd /tmp/vdpm
        
        # Install packages one by one with proper error handling
        ./vdpm sdl2 || {
          echo "Failed to install sdl2, checking for fallback..."
          if [ -f "$GITHUB_WORKSPACE/deps/vita/sdl2.tar.gz" ]; then
            echo "Using precompiled sdl2 from deps/vita/"
            cd $VITASDK/arm-vita-eabi
            tar -xzf "$GITHUB_WORKSPACE/deps/vita/sdl2.tar.gz"
            cd "$GITHUB_WORKSPACE"
          else
            echo "Error: Failed to install sdl2 and no fallback available"
            exit 1
          fi
        }
        
        ./vdpm sdl2_image || echo "Warning: sdl2_image install failed, continuing..."
        ./vdpm sdl2_mixer || echo "Warning: sdl2_mixer install failed, continuing..."
        ./vdpm sdl2_net || echo "Warning: sdl2_net install failed, continuing..."
        
        # Verify SDL2 installation
        echo "Verifying SDL2 installation..."
        if pkg-config --exists sdl2 2>/dev/null; then
          echo "✓ SDL2 installed via pkg-config: $(pkg-config --modversion sdl2)"
          pkg-config --cflags sdl2
          pkg-config --libs sdl2
        elif [ -f "$VITASDK/arm-vita-eabi/include/SDL2/SDL.h" ]; then
          echo "✓ SDL2 headers found at $VITASDK/arm-vita-eabi/include/SDL2/"
        else
          echo "✗ SDL2 not found"
          exit 1
        fi

    - name: Configure CMake
      run: |
        cmake -DCMAKE_TOOLCHAIN_FILE=vita.cmake \
              -DCMAKE_BUILD_TYPE=Release \
              -B build-vita \
              -G Ninja

    - name: Build
      run: |
        cmake --build build-vita --parallel

    - name: Create VPK package
      run: |
        cd build-vita
        mkdir -p sce_sys
        vita-mksfoex -s TITLE_ID=KPFX00001 "KeeperFX" sce_sys/param.sfo
        vita-make-fself -c keeperfx.elf eboot.bin
        vita-pack-vpk -s sce_sys/param.sfo -b eboot.bin ../keeperfx-vita.vpk
        cd ..

    - name: Upload VPK artifact
      uses: actions/upload-artifact@v4
      with:
        name: keeperfx-vita-vpk
        path: keeperfx-vita.vpk

    - name: Upload ELF artifact
      uses: actions/upload-artifact@v4
      with:
        name: keeperfx-vita-elf
        path: build-vita/keeperfx.elf
