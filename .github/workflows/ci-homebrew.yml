name: CI Homebrew

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  build-homebrew:
    name: Build ${{ matrix.name }}
    runs-on: ubuntu-24.04
    container: ${{ matrix.container }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Nintendo 3DS
            preset: 3ds-release
            container: devkitpro/devkitarm:latest
            artifact-name: keeperfx-3ds

          - name: PS Vita
            preset: vita-release
            container: gnuton/vitasdk-docker:latest
            artifact-name: keeperfx-vita

          - name: Nintendo Switch
            preset: switch-release
            container: devkitpro/devkita64:latest
            artifact-name: keeperfx-switch

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Mark git directory as safe
        run: git config --global --add safe.directory '*'

      - name: Setup CMake and Ninja
        uses: lukka/get-cmake@latest

      - name: Configure CMake
        uses: lukka/run-cmake@v10
        with:
          configurePreset: ${{ matrix.preset }}

      - name: Build
        uses: lukka/run-cmake@v10
        with:
          buildPreset: ${{ matrix.preset }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            out/build/${{ matrix.preset }}/*.3dsx
            out/build/${{ matrix.preset }}/*.cia
            out/build/${{ matrix.preset }}/*.vpk
            out/build/${{ matrix.preset }}/*.nro
            out/build/${{ matrix.preset }}/*.elf
          if-no-files-found: warn
